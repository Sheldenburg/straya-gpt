// Next.js API route support: https://nextjs.org/docs/api-routes/introduction
import query from '@/lib/queryApi'
import { adminDb } from '@/styles/firebaseAdmin'
import admin from "firebase-admin"
import type { NextApiRequest, NextApiResponse } from 'next'

type Data = {
    answer: string
}

export default async function handler(
    req: NextApiRequest,
    res: NextApiResponse<Data>
) {

    const { prompt, chatId, model, session } = req.body
    if (!prompt) {
        res.status(400).json({ answer: "Please provide a prompt!" })
        return
    }
    if (!chatId) {
        res.status(400).json({ answer: "Please provide a valid caht ID!" })
        return
    }

    //chatGPT query
    let suffixPrompt = 'Please respond like an Aussie Bloke.'
    // let newPrompt = prefixPrompt.concat(prompt)
    let newPrompt = prompt.concat(suffixPrompt)

    const response = await query(newPrompt, chatId, model)

    const message: Message = {
        text: response || "ChatGPT cannot find an answer for that...",
        createdAt: admin.firestore.Timestamp.now(),
        user: {
            _id: 'ChatGPT',
            name: 'ChatGPT',
            avatar: "data:image/png;base64,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"
        }
    }

    await adminDb.collection('users').doc(session?.user?.email).collection("chats").doc(chatId).collection("messages").add(message)

    res.status(200).json({ answer: message.text })
}
